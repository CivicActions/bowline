#!/usr/bin/env bash

source $(dirname $0)/../lib/bowline/bowline

enter_container
settingspath=/var/www/docroot/sites/default
cd /var/www

if [ ! -d "${settingspath}" ];then
  echo "Looks like Drupal isn't installed. Would you like to install it? [Y,n,7,8]"
  read drupal
  drupal="$(echo ${drupal} | tr 'A-Z' 'a-z')"
  [ "${drupal}" = "n" ] && exit 1

  # Install Drupal
  version="drupal-7"
  if [ "${drupal}" = "8" ];then
    version="drupal-8"
  fi
  composer require drush/drush:8.*
  /var/www/vendor/bin/drush dl --destination=/var/www $version
  [ -d "docroot" ] && mv -v docroot old-docroot
  mv -v drupal-${drupal}* docroot
fi

if [ ! -f "${settingspath}/settings.php" ];then
  cp -v ${settingspath}/default.settings.php ${settingspath}/settings.php
fi

if [ ! "$(grep settings.docker.php ${settingspath}/settings.php)" ]; then
  chmod +w ${settingspath}/settings.php
  echo "" >> ${settingspath}/settings.php
  echo "// Include file for docker database connection." >> ${settingspath}/settings.php
  echo "if (file_exists('/var/www/.docker/etc/settings.docker.php')) {" >> ${settingspath}/settings.php
  echo "  require '/var/www/.docker/etc/settings.docker.php';" >> ${settingspath}/settings.php
  echo "}" >> ${settingspath}/settings.php
  echo "Added require to settings.php"
else
  echo "Docker settings file already initialized."
fi

echo -ne "Hint: If you would like to perform a fresh site install, run this:\n\tdrush si --sites-subdir=default\n\n"

